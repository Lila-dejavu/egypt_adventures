# 新周目系統流程圖

```
┌─────────────────────────────────────────────────────────────┐
│                     遊戲開始                                  │
│                        ↓                                      │
│              檢查是否有攜帶裝備                               │
│                 ↓           ↓                                │
│              有裝備      無裝備                               │
│                 ↓           ↓                                │
│         添加到背包    正常開始                               │
│                 ↓___________↓                                │
│                        ↓                                      │
│                   正常遊戲流程                                │
│                        ↓                                      │
│                 完成所有地圖                                  │
│                        ↓                                      │
│              擊敗最終地圖 Boss                                │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                 【完成畫面顯示】                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │          🎉 恭喜通關！🎉                               │  │
│  │                                                        │  │
│  │  ┌─────────── 完成統計 ────────────┐                  │  │
│  │  │  最終等級: 15                     │                  │  │
│  │  │  累積金幣: 5000                   │                  │  │
│  │  │  完成地圖: 3                      │                  │  │
│  │  │  周目數: 1                        │                  │  │
│  │  └──────────────────────────────────┘                  │  │
│  │                                                        │  │
│  │  選擇一件裝備攜帶至下一周目：                         │  │
│  │  ┌────────────────────────────────┐                   │  │
│  │  │ ⭕ 不攜帶裝備                  │                   │  │
│  │  ├────────────────────────────────┤                   │  │
│  │  │ ⭕ 黃金法杖 (攻+50) [legendary]│                   │  │
│  │  ├────────────────────────────────┤                   │  │
│  │  │ ⭕ 沙漠護甲 (防+30) [epic]     │                   │  │
│  │  ├────────────────────────────────┤                   │  │
│  │  │ ⭕ 神秘護符 (HP+100) [rare]    │                   │  │
│  │  └────────────────────────────────┘                   │  │
│  │                                                        │  │
│  │         [   開始新周目 ➤   ]                           │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                         ↓
            點擊「開始新周目」按鈕
                         ↓
┌─────────────────────────────────────────────────────────────┐
│              儲存選中的裝備到 localStorage                    │
│                        ↓                                      │
│              周目數 +1 (例如: 0 → 1)                         │
│                        ↓                                      │
│                   重新載入頁面                                │
│                        ↓                                      │
│              【新周目開始】                                   │
│     • 玩家狀態重置（等級、生命等）                           │
│     • 難度提升（敵人 +20% 強度）                             │
│     • 獎勵提升（金幣/經驗 +30%）                             │
│     • 攜帶的裝備出現在背包中                                 │
└─────────────────────────────────────────────────────────────┘
```

## 資料流程

```
localStorage 資料結構：

┌──────────────────────────────────────────┐
│  egypt_playthroughs                      │
│  ├─ 類型: 字串（數字）                   │
│  ├─ 範例: "0", "1", "2"...              │
│  └─ 用途: 記錄完成的周目數               │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│  egypt_carryover_equipment               │
│  ├─ 類型: JSON 字串                      │
│  ├─ 範例: {                              │
│  │    "name": "黃金法杖",                │
│  │    "slot": "weapon",                  │
│  │    "atk": 50,                         │
│  │    "rarity": "legendary"              │
│  │  }                                    │
│  ├─ 用途: 暫存攜帶的裝備                 │
│  └─ 生命週期: 一次性使用後刪除           │
└──────────────────────────────────────────┘
```

## 周目難度曲線

```
周目  │ 敵人強度  │ 獎勵倍率  │ 初始難度  │ 地圖步數
─────┼──────────┼──────────┼──────────┼─────────
  1  │  100%    │  100%    │   1.5    │   45
  2  │  120%    │  130%    │   2.0    │   50
  3  │  140%    │  160%    │   2.5    │   55
  4  │  160%    │  190%    │   3.0    │   60
  5  │  180%    │  220%    │   3.3    │   65
  6+ │  +20%/周 │  +30%/周 │  +0.3/周 │  +5/周
```

## 事件時序圖

```
時間軸：Boss 戰勝利 → 顯示完成畫面 → 開始新周目

┌────────────────────────────────────────────────────────────┐
│ Boss 戰                                                      │
│  ├─ 玩家擊敗 Boss                                           │
│  ├─ _handleVictory() 處理獎勵                               │
│  └─ _endBattle()                                            │
│      ├─ 檢測: wasBossBattle && map_steps >= map_goal       │
│      ├─ isGameComplete = true                               │
│      └─ 1.5 秒後 → showVictoryScreen()                     │
└────────────────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────────────────┐
│ 完成畫面顯示                                                 │
│  ├─ 顯示統計資料                                            │
│  ├─ 生成裝備選項                                            │
│  ├─ 設定按鈕事件                                            │
│  └─ 等待玩家選擇...                                         │
└────────────────────────────────────────────────────────────┘
         ↓ (玩家點擊按鈕)
┌────────────────────────────────────────────────────────────┐
│ startNewGamePlus()                                           │
│  ├─ 讀取選中的裝備                                          │
│  ├─ localStorage.setItem('egypt_carryover_equipment', ...)  │
│  ├─ localStorage.setItem('egypt_playthroughs', n+1)         │
│  ├─ 隱藏完成畫面                                            │
│  └─ 0.5 秒後 → location.reload()                           │
└────────────────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────────────────┐
│ 遊戲重新載入                                                 │
│  ├─ Game 建構函式                                           │
│  │   └─ 根據周目數調整初始難度和地圖目標                    │
│  ├─ 載入 Mixins                                             │
│  └─ applyCarryoverEquipment()                               │
│      ├─ 讀取 localStorage                                   │
│      ├─ 添加裝備到 player.inventory                         │
│      ├─ 顯示訊息                                            │
│      └─ 刪除 carryover 資料                                 │
└────────────────────────────────────────────────────────────┘
```

## UI 元素層級

```
Z-index 層級：

20000  - 測試控制台（僅測試頁面）
10000  - 完成畫面主體 (#victory-panel)
 9999  - 完成畫面背景遮罩 (#victory-overlay)
 9000  - 商店面板、背包面板
 3001  - 語言選擇器、音樂控制
 3000  - 其他 UI 元素
    1  - 遊戲主容器
   -1  - 象形文字背景
   -2  - 莎草紙紋理背景
```
